---
- set_fact:
    pipeline_projects:
    - development
    - qa
    - staging
    - production
    pipeline_project_view:
    - kevinconnor
    - burrsutter
    - joshuawilson
    - bleathem
    - kylebuch8
    - etirelli
    pipeline_project_admin:
    - demo
    - burr
    - detiber
- name: Create projects
  command: oadm new-project {{ item }}
  with_items: "{{ pipeline_projects }}"
  register: create_projects
  failed_when: "{{ create_projects.rc == 1 and 'already exists' not in create_projects.stderr }}"
  changed_when: "{{ create_projects.rc == 0 }}"

- name: Add admin users to projects
  command: oc policy add-role-to-user admin {{ item.1 }} -n {{ item.0 }}
  with_nested:
  - "{{ pipeline_projects }}"
  - "{{ pipeline_project_admin }}"
  register: admin_users

- name: Add view users to projects
  command: oc policy add-role-to-user view {{ item.1 }} -n {{ item.0 }}
  with_nested:
  - "{{ pipeline_projects }}"
  - "{{ pipeline_project_view }}"
  register: view_users

- name: Create the git secret
  command: oc secrets new-basicauth git-secret --username={{ demo_pipeline_github_user }} --password={{ demo_pipeline_github_password }} -n {{ pipeline_projects.0 }}
  register: git_secret
  failed_when: "{{ git_secret.rc == 1 and 'already exists' not in git_secret.stderr }}"
  changed_when: "{{ git_secret.rc == 0 }}"

- name: Add the git secret to the builder service account
  command: oc secrets add serviceaccount/builder secrets/git-secret -n {{ pipeline_projects.0 }}
  register: add_git_secret

- name: Create the che oauth client
  shell: >
    echo '{"kind": "OAuthClient", "apiVersion": "v1", "metadata": {"name": "che"}, "secret": "{{ demo_che_oauth_secret }}", "redirectURIs": ["{{ demo_che_oauth_redirect_uri }}"]}' | oc create -f -
  failed_when: "{{ git_secret.rc == 1 and 'already exists' not in git_secret.stderr }}"
  changed_when: "{{ git_secret.rc == 0 }}"
